"use strict";function mxc_son_stop(){audioPlayer&&(audioPlayer.pause(),audioPlayer=null,audioPlayerCurrentUrl=null)}function mxc_son(e,r){var t=!0;audioPlayer&&(audioPlayer.pause(),audioPlayer=null,t=audioPlayerCurrentUrl!=r,audioPlayerCurrentUrl=null),t&&(audioPlayer=window.cordova?new Media(r):new Audio(r),audioPlayerCurrentUrl=r,audioPlayer.play())}function cours_fiche_lien(){}function dic_voc_offline(){}function dic_voc_inline(){}!function(angular){var module=angular.module("educ.ngMtabApi",["educ.ngJsonRpc","educ.ngStorage"]);module.run(["$rootScope",function(e){e.$on("$stateChangeStart",function(){mxc_son_stop()})}]),module.filter("trusted",["$sce",function(e){return function(r){return e.trustAsHtml(r)}}]),module.provider("MtabApi",function(){var url,rpc,userModel,service={},useCache=!0,persistent=!0,lastReconnectTime=0;this.setUrl=function(e){return url=e,this},this.setPersistent=function(e){return persistent=!!e,this},this.useCache=function(e){return useCache=!!e,this},this.$get=["$rootScope","$http","$q","JsonRpc","StorageService",function($rootScope,$http,$q,JsonRpc,storage){function padZero(e){return e>=0&&10>e?"0"+e:e+""}function e(e,r){return{error:e,module:"MtabApi",method:r}}function timestamp(){return(new Date).getTime()/1e3}function needsSession(e){return e&&e.error&&"no-session"==e.error}function rememberSessionId(e){return rpc.url.match(/_eid=/)||(rpc.url+=rpc.url.match(/\?/)?"&":"?",rpc.url+=e),console.log("MtabApi JSON-RPC url",rpc.url),!0}function forgetSessionId(){return rpc.url.match(/_eid=/)&&(rpc.url=rpc.url.replace(/_eid=\w*/,""),rpc.url=rpc.url.replace(/\?$/,""),rpc.url=rpc.url.replace(/&$/,"")),console.log("MtabApi JSON-RPC url",rpc.url),!0}function forgetUserModel(){return window.userModel=userModel=null,sessionStorage.removeItem("mtab-user"),!0}function setUserModel(e){if(e instanceof UserModel)return window.userModel=userModel=e,persistent&&sessionStorage.setItem("mtab-user",JSON.stringify(userModel)),!0;throw"MtabApi setUserModel must have a UserModel !"}function retreiveUsermodel(){var userData=null;try{eval("userData = "+sessionStorage.getItem("mtab-user"))}catch(e){}userData&&(setUserModel(new UserModel(userData)),!!userData.session&&forgetSessionId()&&rememberSessionId(userData.session))}function hasUserModel(){return userModel instanceof UserModel}function getUserModel(){if(userModel instanceof UserModel)return userModel;throw"MtabApi getUserModel must have a UserModel !"}function cacheSet(e,r,t){var n=e+"-"+r;try{storage.setItem(n,JSON.stringify(t))}catch(o){alert("cache : storage.clearMatching ^"+e+"-"),cacheClearMatching(storage,new RegExp("^"+e+"-")),storage.setItem(n,JSON.stringify(t))}}function cacheClearMatching(e,r){for(var t in e)e.hasOwnProperty(t)&&t.match(r)&&e.removeItem(t)}function cacheGet(cache,key){var storageKey=cache+"-"+key,value;try{var json=storage.getItem(storageKey);eval("value = "+json)}catch(e){}return value}function cacheHas(e,r){var t=e+"-"+r;return!!storage.getItem(t)}function cacheRemove(e,r){var t=e+"-"+r;storage.removeItem(t)}function cacheResolved(e){var r=$q.defer();return r.resolve(e),r.promise}function UserModel(e){angular.copy(e,this)}function processNotifications(e,r){var t=r.notifications;if(0==t.length)r.lastNotificationId&&e.$notificationsLastReceivedId<r.lastNotificationId&&(e.$notificationsLastReceivedId=r.lastNotificationId);else{var n,o=[],s={};t.forEach(function(e){o.push({name:"system-notification-acknowledge",notificationId:e.id}),n=e.name,s[n]||(s[n]=[]),s[n].push(e)}),e.$notificationsLastReceivedId=t[t.length-1].id;for(n in s)s.hasOwnProperty(n)&&$rootScope.$broadcast(n,s[n]);e.sendObsels(o)}}function ArboModel(e){angular.copy(e,this)}function OpdModel(e){angular.copy(e,this),this.answers&&this.answers.forEach(function(e,r){e.indexInOpd=r});var r=new RegExp("opd/"+this.opdId+"/","g"),t="http://e.maxicours.com/";this.recursiveWalk(function(e,n){"html"==n&&(e[n]=e[n].replace(r,t))},this)}return rpc=JsonRpc.entrypoint(url),persistent?retreiveUsermodel():(forgetUserModel(),forgetSessionId()),service.tryToReuseExistingSession=function(){var e=$q.defer();return $http.get(url+"/_eid.php",{withCredentials:!0}).success(function(r,t,n,o){r&&t>=200&&299>=t?e.resolve(r):e.reject(t)}).error(function(r,t,n,o){e.reject(t)}),e.promise.then(function(e){if(e){forgetSessionId(),rememberSessionId(e);var r=$q.defer();return service.call("MTAB_User::current",[]).promise.then(function(e){setUserModel(new UserModel(e)),forgetSessionId(),rememberSessionId(userModel.session),console.log("MtabApi reused user",userModel),r.resolve(getUserModel())},function(){console.log("MtabApi can't reuse a user (no current user in existing session)"),r.resolve(!1)}),r.promise}return console.log("MtabApi can't reuse a user (no existing session)"),!1})},service.useCache=function(e){return useCache=!!e,this},service.hasUser=function(){return!!userModel&&!!userModel.uid&&!!userModel.uref},service.getUser=function(){return getUserModel()},service.changeClasse=function(e){if(service.hasUser())return getUserModel().changeClasse(e);throw"can't change classe without user"},service.canReconnect=function(){return service.hasUser()&&2<timestamp()-lastReconnectTime},service.strongAuthent=function(e,r,t){return service.call("MTAB_User::strongAuthent",[e,r,t]).promise.then(function(e){return setUserModel(new UserModel(e)),forgetSessionId(),rememberSessionId(userModel.session),console.log("MtabApi strongAuthent",userModel),getUserModel()})},service.weakAuthent=function(e,r,t){return service.call("MTAB_User::weakAuthent",[e,r,t]).promise.then(function(e){var r,t;if(hasUserModel()){r=getUserModel();for(t in r)delete r[t];for(t in e)r[t]=e[t]}else r=new UserModel(e);return setUserModel(r),forgetSessionId(),rememberSessionId(r.session),console.log("MtabApi weakAuthent",r),getUserModel()})},service.logout=function(){return service.call("MTAB_User::logout",[]).promise.then(function(){forgetUserModel()})},service.arboGetAllClasses=function(){var e="miscCache",r="allClasses";return useCache&&cacheHas(e,r)?cacheResolved(cacheGet(e,r)):service.call("MTAB_Arbo::getAllClasses",[]).promise.then(function(t){return useCache&&cacheSet(e,r,t),t})},service.arboGet=function(e){var r="arboCache",t=getUserModel().classe.meta,n=t+"-"+e;return useCache&&cacheHas(r,n)?cacheResolved(new ArboModel(cacheGet(r,n))):service.withAutoReconnect(function(){return service.call("MTAB_Arbo::get",[e]).promise.then(function(e){var t=new ArboModel(e);return useCache&&cacheSet(r,n,t),t})})},service.arboGetMany=function(e){!angular.isArray(e)&&angular.isString(e)&&(e=e.split(/\D+/));var r,t=getUserModel().classe.meta,n="arboCache",o={},s=[];return e.forEach(function(e){if(useCache){var r=t+"-"+e;cacheHas(n,r)?o[e]=new ArboModel(cacheGet(n,r)):s.push(e)}else s.push(e)}),r=s.length?service.withAutoReconnect(function(){return service.call("MTAB_Arbo::getMany",[s]).promise.then(function(e){return e.forEach(function(e){var r=new ArboModel(e);if(useCache){var s=t+"-"+r.boId;cacheSet(n,s,r)}o[r.boId]=r}),o})}):cacheResolved(o),r.then(function(r){var t=[];return e.forEach(function(e){t.push(r[e])}),t})},service.opdGet=function(e){var r="opdCache",t=e;return useCache&&cacheHas(r,t)?cacheResolved(new OpdModel(cacheGet(r,t))):service.withAutoReconnect(function(){return service.call("MTAB_Opd::get",[e]).promise.then(function(e){var n=new OpdModel(e);return useCache&&cacheSet(r,t,n),n})})},service.opdGetMany=function(e){!angular.isArray(e)&&angular.isString(e)&&(e=e.split(/\D+/));var r,t="opdCache",n=[],o=[];return e.forEach(function(e){useCache&&cacheHas(t,e)?n[e]=new OpdModel(cacheGet(t,e)):o.push(e)}),r=o.length?service.withAutoReconnect(function(){return service.call("MTAB_Opd::getMany",[o]).promise.then(function(e){return e.forEach(function(e){var r=new OpdModel(e);useCache&&cacheSet(t,r.opdId,r),n[r.opdId]=r}),n})}):cacheResolved(n),r.then(function(r){var t=[];return e.forEach(function(e){t.push(r[e])}),t})},service.dateToSqlDatetime=function(e){return e instanceof Date?[[e.getFullYear(),padZero(e.getMonth()+1),padZero(e.getDate())].join("-"),[padZero(e.getHours()),padZero(e.getMinutes()),padZero(e.getSeconds())].join(":")].join(" "):e},service.traceGetPeriode=function(e,r,t){var n=service.dateToSqlDatetime(r),o=service.dateToSqlDatetime(t);return service.withAutoReconnect(function(){return service.call("MTAB_Trace::getPeriode",[e,n,o]).promise.then(function(e){return e})})},service.showSoundButtons=function(){var e=jQuery(document.body).find('[data-opd-id] a[onclick^="mxc_son"]');e.show()},service.hideSoundButtons=function(){var e=jQuery(document.body).find('[data-opd-id] a[onclick^="mxc_son"]');e.hide()},service.call=function(){return rpc.call.apply(rpc,arguments)},service.withAutoReconnect=function(r){var t=$q.defer();return r().then(t.resolve,function(n){needsSession(n)?(console.log("MtabApi : trying to auto-reconnect..."),service.canReconnect()?(console.log("MtabApi : reconnection..."),lastReconnectTime=timestamp(),service.weakAuthent(userModel.uid,userModel.uref,userModel.classe.meta).then(function(){r().then(t.resolve,t.reject)})["catch"](t.reject)):(console.log("MtabApi : can't reconnect"),t.reject(e("please-wait","withAutoReconnect")))):t.reject(n)}),t.promise},UserModel.prototype.logout=function(){return service.logout()},UserModel.prototype.getAllClasses=function(e){return service.withAutoReconnect(function(){return service.call("MTAB_User::getAllClasses",[e]).promise.then(function(e){return e})})},UserModel.prototype.changeClasse=function(e){return service.withAutoReconnect(function(){return service.call("MTAB_User::changeClasse",[e]).promise.then(function(e){var r,t=getUserModel();for(r in t)delete t[r];for(r in e)t[r]=e[r];return setUserModel(t),console.log("MtabApi changeClasse",t),t})})},UserModel.prototype.getMiddleClasseMeta=function(){var e=Math.max(0,Math.min(this.classes.length-1,Math.floor(this.classes.length/2)));return this.classes[e].meta},UserModel.prototype.obselify=function(e){if(!e.name)throw console.error("bad obsel : missing name",e),"bad-obselify";if(e.clientTimestamp||(e.clientTimestamp=(new Date).getTime()/1e3),e.clientTime||(e.clientTimestamp=new Date(1e3*e.clientTimestamp).toUTCString()),!this.$windowId){var r=this.session.match(/eid=(\S+)/);this.$windowId=r[1]}return e.windowId=this.$windowId,e},UserModel.prototype.sendObsels=function(e){var r=this;return e.forEach(function(e){r.obselify(e)}),service.call("MTAB_Trace::receiveObsels",[e,this.$windowId,this.$notificationsLastReceivedId||null]).promise.then(function(e){return processNotifications(r,e)})},UserModel.prototype.sendObsel=function(e){this.obselify(e);var r=this;return service.call("MTAB_Trace::receiveObsel",[e,this.$windowId,this.$notificationsLastReceivedId||null]).promise.then(function(e){return processNotifications(r,e)})},ArboModel.prototype.fetchChild=function(e){var r,t=this,n=!1;if(this.childs.forEach(function(r,t){r.boId==e&&(n=t)}),n!==!1)return t.childs[n]instanceof ArboModel?(r=$q.defer(),r.resolve(t.childs[n]),r.promise):service.arboGet(e).then(function(e){t.childs[n]=e});throw"child-not-found"},ArboModel.prototype.fetchChilds=function(){var e;if(this.$fetchChilds)return e=$q.defer(),e.resolve(this.childs),e.promise;var r=this,t=[];return this.childs.forEach(function(e){t.push(e.boId)}),t.length?service.arboGetMany(t).then(function(e){return e.forEach(function(e,t){r.childs[t]=e}),r.$fetchChilds=!0,e}):(e=$q.defer(),e.resolve([]),e.promise)},OpdModel.prototype.recursiveWalk=function(e,r){var t=this;if(angular.isArray(r))r.forEach(function(n,o){e(r,o),t.recursiveWalk(e,r[o])});else if(angular.isObject(r))for(var n in r)r.hasOwnProperty(n)&&(e(r,n),t.recursiveWalk(e,r[n]))},service}]})}(angular);var audioPlayer,audioPlayerCurrentUrl;